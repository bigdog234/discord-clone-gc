import React, { useEffect, useState, useRef } from "react";

// GC Web App - Single-file React component
// Drop this component into a React + Tailwind project (Vite or CRA with Tailwind)
// Default export is the app component.

export default function GCApp() {
  // --- Basic app state ---
  const [username, setUsername] = useState(() => {
    return localStorage.getItem("gc_username") || "Guest" + Math.floor(Math.random() * 900 + 100);
  });
  const [currentRoom, setCurrentRoom] = useState(() => {
    return localStorage.getItem("gc_currentRoom") || "General";
  });
  const [rooms, setRooms] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem("gc_rooms_v1")) || { General: { name: "General", messages: [] } };
    } catch (e) {
      return { General: { name: "General", messages: [] } };
    }
  });
  const [message, setMessage] = useState("");
  const [search, setSearch] = useState("");
  const [showSidebar, setShowSidebar] = useState(true);
  const [typingUsers, setTypingUsers] = useState({});
  const messageListRef = useRef(null);

  // helper to persist
  useEffect(() => {
    localStorage.setItem("gc_rooms_v1", JSON.stringify(rooms));
  }, [rooms]);
  useEffect(() => localStorage.setItem("gc_username", username), [username]);
  useEffect(() => localStorage.setItem("gc_currentRoom", currentRoom), [currentRoom]);

  // scroll to bottom when messages update
  useEffect(() => {
    const el = messageListRef.current;
    if (el) {
      requestAnimationFrame(() => {
        el.scrollTop = el.scrollHeight;
      });
    }
  }, [rooms, currentRoom]);

  // --- Room functions ---
  function createRoom(name) {
    if (!name) return;
    if (rooms[name]) {
      alert("Room already exists");
      return;
    }
    setRooms((r) => ({ ...r, [name]: { name, messages: [] } }));
    setCurrentRoom(name);
  }

  function sendMessage({ text, files = [] }) {
    const timestamp = new Date().toISOString();
    const msg = {
      id: Math.random().toString(36).slice(2, 9),
      author: username,
      text,
      files: files.map((f) => ({ name: f.name, size: f.size, dataUrl: f.dataUrl })),
      reactions: {},
      edited: false,
      ts: timestamp,
    };
    setRooms((r) => {
      const next = { ...r };
      next[currentRoom] = { ...next[currentRoom], messages: [...next[currentRoom].messages, msg] };
      return next;
    });
    setMessage("");
    setTypingUsers((t) => ({ ...t, [username]: false }));

    // optional: simulated bot response for fun
    simulateBotResponse(text);
  }

  function simulateBotResponse(userText) {
    // simple fun behaviour: if message includes "bot" or "help" the bot replies
    const lower = userText.toLowerCase();
    if (lower.includes("@bot") || lower.includes("help") || lower.includes("joke")) {
      const reply = {
        id: Math.random().toString(36).slice(2, 9),
        author: "HelperBot",
        text: `Hi ${username}! You wrote: "${userText}" ‚Äî type @bot help for quick commands (channels, /me).`,
        files: [],
        reactions: {},
        edited: false,
        ts: new Date(Date.now() + 800).toISOString(),
      };
      setTimeout(() => {
        setRooms((r) => {
          const next = { ...r };
          if (!next[currentRoom]) return next;
          next[currentRoom] = { ...next[currentRoom], messages: [...next[currentRoom].messages, reply] };
          return next;
        });
      }, 800 + Math.random() * 600);
    }
  }

  function addReaction(messageId, emoji) {
    setRooms((r) => {
      const next = { ...r };
      const msgs = next[currentRoom].messages.map((m) => {
        if (m.id !== messageId) return m;
        const reactions = { ...m.reactions };
        reactions[emoji] = (reactions[emoji] || 0) + 1;
        return { ...m, reactions };
      });
      next[currentRoom] = { ...next[currentRoom], messages: msgs };
      return next;
    });
  }

  function deleteMessage(messageId) {
    setRooms((r) => {
      const next = { ...r };
      next[currentRoom] = { ...next[currentRoom], messages: next[currentRoom].messages.filter((m) => m.id !== messageId) };
      return next;
    });
  }

  function editMessage(messageId, newText) {
    setRooms((r) => {
      const next = { ...r };
      next[currentRoom] = {
        ...next[currentRoom],
        messages: next[currentRoom].messages.map((m) => (m.id === messageId ? { ...m, text: newText, edited: true } : m)),
      };
      return next;
    });
  }

  // file upload handler: convert selected files to dataURLs for local preview + storage
  async function handleFiles(files) {
    const arr = Array.from(files || []);
    const readPromises = arr.map((f) =>
      new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve({ name: f.name, size: f.size, dataUrl: e.target.result });
        reader.readAsDataURL(f);
      })
    );
    return Promise.all(readPromises);
  }

  // typing indicator
  useEffect(() => {
    const timeout = setInterval(() => {
      // clear typing indicator for others after some time
      setTypingUsers((t) => {
        const next = { ...t };
        Object.keys(next).forEach((k) => {
          if (next[k] && Date.now() - next[k].since > 4000) delete next[k];
        });
        return next;
      });
    }, 2000);
    return () => clearInterval(timeout);
  }, []);

  function setUserTyping(isTyping) {
    setTypingUsers((t) => ({ ...t, [username]: isTyping ? { since: Date.now() } : false }));
  }

  // search within current room
  const messagesToShow = (rooms[currentRoom]?.messages || []).filter((m) => {
    if (!search) return true;
    const s = search.toLowerCase();
    return m.text.toLowerCase().includes(s) || m.author.toLowerCase().includes(s);
  });

  // file input ref
  const fileRef = useRef(null);

  // keyboard submit: Enter to send, Shift+Enter for newline
  function handleKeyDown(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      if (message.trim()) sendMessage({ text: message });
    }
  }

  // quick commands / slash commands support
  async function tryHandleSlashCommands(text) {
    if (!text.startsWith("/")) return false;
    const parts = text.slice(1).split(" ");
    const cmd = parts[0].toLowerCase();
    const arg = parts.slice(1).join(" ");

    if (cmd === "join") {
      if (!arg) {
        alert("Usage: /join room-name");
        return true;
      }
      if (!rooms[arg]) createRoom(arg);
      setCurrentRoom(arg);
      return true;
    }
    if (cmd === "me") {
      sendMessage({ text: `* ${username} ${arg}` });
      return true;
    }
    if (cmd === "whoami") {
      sendMessage({ text: `I am ${username}` });
      return true;
    }
    if (cmd === "nick") {
      if (!arg) return true;
      setUsername(arg);
      return true;
    }
    // unknown command
    sendMessage({ text: `Unknown command: ${cmd}. Try /join, /me, /nick` });
    return true;
  }

  // handle file selection + send
  async function handleSendWithFiles(e) {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    const fdata = await handleFiles(files);
    sendMessage({ text: message, files: fdata });
    // reset file input
    e.target.value = null;
  }

  // small helpers for formatting time
  function prettyTime(iso) {
    const d = new Date(iso);
    return d.toLocaleString();
  }

  // simple export/import state
  function exportState() {
    const data = JSON.stringify({ rooms, username, currentRoom }, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gc-export.json";
    a.click();
    URL.revokeObjectURL(url);
  }
  function importStateFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        if (parsed.rooms) setRooms(parsed.rooms);
        if (parsed.username) setUsername(parsed.username);
        if (parsed.currentRoom) setCurrentRoom(parsed.currentRoom);
      } catch (err) {
        alert("Invalid file");
      }
    };
    reader.readAsText(file);
  }

  // UI
  return (
    <div className="min-h-screen bg-gray-50 flex">
      {/* Sidebar */}
      <aside className={`w-72 p-3 border-r bg-white transition-transform ${showSidebar ? "" : "-translate-x-full"}`}>
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-lg font-bold">GC</h2>
          <div className="text-sm text-gray-500">Signed in as <strong>{username}</strong></div>
        </div>

        <div className="mb-3">
          <label className="block text-xs text-gray-500">Switch user</label>
          <input value={username} onChange={(e) => setUsername(e.target.value)} className="w-full mt-1 p-2 border rounded" />
        </div>

        <div className="mb-2">
          <label className="block text-xs text-gray-500">Search room</label>
          <input value={search} onChange={(e) => setSearch(e.target.value)} className="w-full mt-1 p-2 border rounded" placeholder="Search messages or authors" />
        </div>

        <div className="mb-3">
          <label className="block text-xs text-gray-500">Rooms</label>
          <div className="mt-2 space-y-2">
            {Object.keys(rooms).map((r) => (
              <button key={r} onClick={() => setCurrentRoom(r)} className={`w-full text-left p-2 rounded ${r === currentRoom ? "bg-blue-50 border" : "hover:bg-gray-50"}`}>
                <div className="flex justify-between">
                  <div className="font-medium">{r}</div>
                  <div className="text-xs text-gray-400">{rooms[r].messages.length}</div>
                </div>
              </button>
            ))}
          </div>
          <div className="mt-2 flex gap-2">
            <input id="newRoom" className="flex-1 p-2 border rounded" placeholder="New room name" onKeyDown={(e) => { if (e.key === 'Enter') createRoom(e.target.value); }} />
            <button onClick={() => { const v = document.getElementById('newRoom').value; createRoom(v); document.getElementById('newRoom').value = ''; }} className="px-3 py-2 bg-blue-600 text-white rounded">Create</button>
          </div>
        </div>

        <div className="mt-4 text-sm text-gray-600">
          <div className="mb-2">Tips:</div>
          <ul className="list-disc pl-5">
            <li>Slash commands: <code>/join room-name</code>, <code>/me</code>, <code>/nick newname</code></li>
            <li>Use <code>@bot</code> or the word "help" for a quick helper response.</li>
            <li>Export / import the whole state below.</li>
          </ul>
        </div>

        <div className="mt-4 flex gap-2">
          <button onClick={() => exportState()} className="flex-1 p-2 border rounded">Export</button>
          <label className="flex-1 p-2 border rounded text-center cursor-pointer">
            Import
            <input type="file" accept="application/json" onChange={(e) => importStateFromFile(e.target.files[0])} className="hidden" />
          </label>
        </div>
      </aside>

      {/* Main area */}
      <main className="flex-1 flex flex-col">
        <header className="p-3 border-b bg-white flex items-center justify-between">
          <div className="flex items-center gap-3">
            <button onClick={() => setShowSidebar((s) => !s)} className="p-2 rounded hover:bg-gray-100">‚ò∞</button>
            <h1 className="text-xl font-semibold">#{currentRoom}</h1>
            <div className="text-sm text-gray-500">{rooms[currentRoom]?.messages.length || 0} messages</div>
          </div>
          <div className="flex items-center gap-3">
            <div className="text-sm text-gray-500">{Object.keys(typingUsers).some((k) => typingUsers[k]) ? "someone is typing..." : ""}</div>
            <button className="p-2 rounded hover:bg-gray-100" onClick={() => { setRooms({ General: { name: 'General', messages: [] } }); setCurrentRoom('General'); }}>Reset</button>
          </div>
        </header>

        <div className="flex-1 overflow-hidden flex">
          <section className="flex-1 p-4 flex flex-col">
            {/* messages list */}
            <div ref={messageListRef} className="flex-1 overflow-auto p-2 bg-white border rounded">
              {messagesToShow.length === 0 ? (
                <div className="text-center text-gray-400 mt-8">No messages yet ‚Äî say hi üëã</div>
              ) : (
                messagesToShow.map((m) => (
                  <article key={m.id} className="mb-3 p-2 border-b last:border-b-0">
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-semibold">{m.author} {m.author === 'HelperBot' ? <span className="text-xs text-gray-400 ml-2">bot</span> : null}</div>
                        <div className="text-xs text-gray-400">{prettyTime(m.ts)} {m.edited ? "¬∑ edited" : ""}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={() => addReaction(m.id, "üëç")} className="px-2 py-1 rounded hover:bg-gray-100">üëç</button>
                        <button onClick={() => addReaction(m.id, "üòÇ")} className="px-2 py-1 rounded hover:bg-gray-100">üòÇ</button>
                        {m.author === username ? (
                          <button onClick={() => { const newText = prompt('Edit message', m.text); if (newText != null) editMessage(m.id, newText); }} className="px-2 py-1 rounded hover:bg-gray-100">edit</button>
                        ) : null}
                        {m.author === username || username === 'Guest' ? (
                          <button onClick={() => { if (confirm('Delete message?')) deleteMessage(m.id); }} className="px-2 py-1 rounded hover:bg-gray-100">del</button>
                        ) : null}
                      </div>
                    </div>

                    <div className="mt-2 whitespace-pre-wrap">{m.text}</div>
                    {m.files && m.files.length > 0 ? (
                      <div className="mt-2 grid grid-cols-3 gap-2">
                        {m.files.map((f, i) => (
                          <div key={i} className="border rounded p-1 text-xs">
                            <div className="truncate">{f.name}</div>
                            {f.dataUrl && f.dataUrl.startsWith('data:image') ? <img src={f.dataUrl} alt={f.name} className="mt-1 max-h-32 object-contain" /> : null}
                            <div className="text-gray-400 text-xs">{Math.round(f.size / 1024)} KB</div>
                          </div>
                        ))}
                      </div>
                    ) : null}

                    {m.reactions && Object.keys(m.reactions).length > 0 ? (
                      <div className="mt-2 flex gap-2 text-sm">
                        {Object.entries(m.reactions).map(([k, v]) => (
                          <div key={k} className="px-2 py-1 border rounded">{k} {v}</div>
                        ))}
                      </div>
                    ) : null}
                  </article>
                ))
              )}
            </div>

            {/* typing indicator */}
            <div className="mt-2 text-xs text-gray-500">{Object.keys(typingUsers).filter((k) => typingUsers[k] && k !== username).join(', ')}</div>

            {/* message composer */}
            <div className="mt-3 bg-white p-3 border rounded">
              <div className="flex gap-2">
                <textarea
                  value={message}
                  onChange={(e) => { setMessage(e.target.value); setUserTyping(e.target.value.length > 0); }}
                  onKeyDown={handleKeyDown}
                  placeholder={`Message #${currentRoom}. Press Enter to send, Shift+Enter for newline.`}
                  className="flex-1 p-2 border rounded h-24 resize-none"
                />
                <div className="w-36 flex flex-col gap-2">
                  <input ref={fileRef} onChange={handleSendWithFiles} type="file" multiple className="" />
                  <button onClick={async () => {
                    // check for slash command
                    const handled = await tryHandleSlashCommands(message.trim());
                    if (!handled) sendMessage({ text: message });
                  }} className="p-2 bg-blue-600 text-white rounded">Send</button>
                  <button onClick={() => { setMessage(''); setUserTyping(false); }} className="p-2 border rounded">Clear</button>
                </div>
              </div>

              <div className="mt-2 text-xs text-gray-500">Commands: /join, /me, /nick, /whoami</div>
            </div>
          </section>

          {/* right column: members & info */}
          <aside className="w-72 p-3 border-l bg-white">
            <div className="font-semibold mb-2">Members</div>
            <div className="text-sm text-gray-600 mb-4">(local demo ‚Äî members represent usernames you've used on this browser)</div>
            <div className="space-y-2 mb-4">
              {/* list of unique authors in current room */}
              {Array.from(new Set((rooms[currentRoom]?.messages || []).map((m) => m.author))).map((u) => (
                <div key={u} className="flex items-center justify-between p-2 border rounded">
                  <div>
                    <div className="font-medium">{u}</div>
                    <div className="text-xs text-gray-400">joined (local)</div>
                  </div>
                  <div className="text-sm text-gray-500">{u === username ? 'You' : ''}</div>
                </div>
              ))}

              {((rooms[currentRoom]?.messages || []).length === 0) && (
                <div className="text-sm text-gray-400">No members yet ‚Äî send a message to appear here.</div>
              )}
            </div>

            <div className="mt-4">
              <div className="font-semibold mb-2">Room actions</div>
              <div className="flex gap-2">
                <button onClick={() => { const copy = JSON.stringify(rooms[currentRoom] || {}); navigator.clipboard.writeText(copy); alert('Room copied to clipboard'); }} className="flex-1 p-2 border rounded">Copy room</button>
                <button onClick={() => { if (confirm('Delete this room?')) { const next = { ...rooms }; delete next[currentRoom]; setRooms(next); setCurrentRoom(Object.keys(next)[0] || 'General'); } }} className="flex-1 p-2 border rounded">Delete</button>
              </div>
            </div>

            <div className="mt-4 text-xs text-gray-500">This demo stores everything in your browser's localStorage. To share with others, export and send the .json file or deploy with a backend.</div>
          </aside>
        </div>
      </main>
    </div>
  );
}
